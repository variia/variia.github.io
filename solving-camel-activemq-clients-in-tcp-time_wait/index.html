<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Solving Camel ActiveMQ Clients in TCP TIME_WAIT" /><meta name="author" content="Iván Ádám Vári" /><meta property="og:locale" content="en" /><meta name="description" content="Solving camel activemq clients in tcp time_wait for java applications that make large number of asynchronous request." /><meta property="og:description" content="Solving camel activemq clients in tcp time_wait for java applications that make large number of asynchronous request." /><link rel="canonical" href="https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/" /><meta property="og:url" content="https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/" /><meta property="og:site_name" content="Ivan Adam Vari" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-06-04T23:25:27+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Solving Camel ActiveMQ Clients in TCP TIME_WAIT" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Iván Ádám Vári" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Iván Ádám Vári"},"dateModified":"2014-06-04T23:25:27+02:00","datePublished":"2014-06-04T23:25:27+02:00","description":"Solving camel activemq clients in tcp time_wait for java applications that make large number of asynchronous request.","headline":"Solving Camel ActiveMQ Clients in TCP TIME_WAIT","mainEntityOfPage":{"@type":"WebPage","@id":"https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/"},"url":"https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/"}</script><title>Solving Camel ActiveMQ Clients in TCP TIME_WAIT | Ivan Adam Vari</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ivan Adam Vari"><meta name="application-name" content="Ivan Adam Vari"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-GST9H3668K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GST9H3668K'); </script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ivan Adam Vari</a></div><div class="site-subtitle font-italic">A minimalist SysOps/DevOps Craftsman</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/variia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ivan.adam.vari','ivanvari.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/profile/view?id=ADEAAAZ6wwEBp7FjAqg_m7ZK8y148UI70Cyn9n8" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Solving Camel ActiveMQ Clients in TCP TIME_WAIT</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Solving Camel ActiveMQ Clients in TCP TIME_WAIT</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/variia">Iván Ádám Vári</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1401917127" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2014-06-04 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="402 words"> <em>2 min</em> read</span></div></div></div><div class="post-content"><p>We are an agile software development company and agile is great for “moving target”. We plan, work and implement changes in small batches and ongoing re-factoring is just the nature of what we do.</p><p>We recently added some functionality as well as increased traffic for one of our Java products utilising <a href="http://camel.apache.org" target="_blank">Apache Camel</a> and <a href="http://activemq.apache.org" target="_blank">ActiveMQ</a>. The product has been in production for years now, functioning with very much zero defect rate. Not soon after deploying the new code, our monitoring system triggered alerts about unusually high TCP TIME_WAIT connection states on the server where the new code was running. We began the troubleshooting process and found they were all ActiveMQ connections to our broker. Our developers immediately confirmed that</p><p>“<em>there was no change on the ActiveMQ connection manager side.</em>”</p><p>Well, it turned out that it was exactly the problem.</p><h2 id="solving-camel-activemq-clients-in-tcp-time_wait"><span class="mr-2">Solving Camel ActiveMQ Clients in TCP TIME_WAIT</span><a href="#solving-camel-activemq-clients-in-tcp-time_wait" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I started looking various aspects of our environment but was unable to pinpoint where the problem was coming from. So I shifted my focus onto our client implementation, despite the confirmation from the developers.</p><p><img data-src="/assets/img/2014-06/DC3DA587-A560-4F29-97E1-B814380F14DE.png" alt="TCP Sockets by week" data-proofer-ignore></p><p>Note: it’s perfectly natural to have these especially on systems that deal with lots of short lived requests from client connections over unreliable public networks. In nutshell, the local TCP stack waits for twice the maximum segment lifetime (MSL) to pass (120 sec default) before it finishes CLOSING to be sure that the remote end-point received the acknowledgement (and was not queued on upstream routers). Normally it’s harmless, although in large volume could cause memory overflow.</p><p>We did have enough <a href="http://en.wikipedia.org/wiki/Ephemeral_port" target="_blank">ephemeral ports</a> to support 3.5K TIME_WAIT sockets, my issue was that it was an extra ~1K and coming from my local network.</p><p>While looking at our code, I spotted something interesting in our client implementation, we used <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/spring/ActiveMQConnectionFactory.html" target="_blank"><em>ActiveMQConnectionFactory</em></a> instead of <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/pool/PooledConnectionFactory.html" target="_blank">PooledConnectionFactory</a>. Although our application was functioning, large volume of asynchronous messages created overhead around socket maintenance on server what we don’t need. After replacing our code to use PooledConnectionFactory, we loaded the application into our test environment to confirm the affect.</p><p>ActiveMQConnectionFactory (old):</p><ul><li>24 ESTABLISHED connections to the broker<li>~150 TIME_WAIT sockets after the initial startup burst of ~1000</ul><p>PooledConnectionFactory (new):</p><ul><li>6 ESTABLISHED connections to the broker<li>0 TIME_WAIT sockets</ul><p>We managed to reproduce this 100% in our test environment, and deploying the new code into production had not affected our throughput either.</p><p><img data-src="/assets/img/2014-06/AC3DC564-HDFG-4829-97E1-B814380K1421.png" alt="TCP Sockets by day" data-proofer-ignore></p><blockquote class="prompt-tip"><div><p>Camel, which uses Spring JMS underneath benefits from pooling aware JMS ConnectionFactory such as PooledConnectionFactory hence it is always recommended.</p></div></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/activemq/" class="post-tag no-text-decoration" >activemq</a> <a href="/tags/camel/" class="post-tag no-text-decoration" >camel</a> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Solving Camel ActiveMQ Clients in TCP TIME_WAIT - Ivan Adam Vari&amp;url=https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Solving Camel ActiveMQ Clients in TCP TIME_WAIT - Ivan Adam Vari&amp;u=https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/&amp;text=Solving Camel ActiveMQ Clients in TCP TIME_WAIT - Ivan Adam Vari" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cluster/">cluster</a> <a class="post-tag" href="/tags/couchbase/">couchbase</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/cfn/">cfn</a> <a class="post-tag" href="/tags/cloudformation/">cloudformation</a> <a class="post-tag" href="/tags/hardware/">hardware</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/solving-poor-performance-on-rhel-and-centos-7/"><div class="card-body"> <em class="timeago small" data-ts="1487261757" > 2017-02-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Solving Poor Network Performance on RHEL and CentOS 7</h3><div class="text-muted small"><p> We are building the next generation online marketplace and part of it is a real-time Java application. This application is heavily optimised for its use case, handles zillions of short-lived tcp re...</p></div></div></a></div><div class="card"> <a href="/aws-codepipeline-stuck-at-cloudformation-prepare-stage/"><div class="card-body"> <em class="timeago small" data-ts="1654426722" > 2022-06-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS Codepipeline Stuck at Cloudformation Prepare Stage</h3><div class="text-muted small"><p> This issue puzzled me and even AWS support for weeks, although for the later it was mostly because of their availability not their skills: I pushed in an update for one of my pipeline managed s...</p></div></div></a></div><div class="card"> <a href="/macOS-battery-health-and-optimised-charging/"><div class="card-body"> <em class="timeago small" data-ts="1650918798" > 2022-04-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>macOS Optimised Battery Charging</h3><div class="text-muted small"><p> I use my Macbook in clamshell mode most of the time. Back in the day with my old Retina Macbook, I disconnected my charger couple of times a week to discharge the battery regularly. This simple pra...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/script-clone-saltstack-formulas-github/" class="btn btn-outline-primary" prompt="Older"><p>Script to Clone SaltStack Formulas from GitHub</p></a> <a href="/running-pylint-in-pycharm/" class="btn btn-outline-primary" prompt="Newer"><p>Running Pylint in PyCharm</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://ivanvari.com/solving-camel-activemq-clients-in-tcp-time_wait/'; this.page.identifier = '/solving-camel-activemq-clients-in-tcp-time_wait/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://ivanvari-com.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/variia">Iván Ádám Vári</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cluster/">cluster</a> <a class="post-tag" href="/tags/couchbase/">couchbase</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/cfn/">cfn</a> <a class="post-tag" href="/tags/cloudformation/">cloudformation</a> <a class="post-tag" href="/tags/hardware/">hardware</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-84719456-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-84719456-1'); }); </script>
