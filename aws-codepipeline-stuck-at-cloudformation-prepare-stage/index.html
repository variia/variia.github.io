<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="AWS Codepipeline Stuck at Cloudformation Prepare Stage" /><meta name="author" content="Iván Ádám Vári" /><meta property="og:locale" content="en" /><meta name="description" content="AWS Codepipeline cloudformation prepare stage not completing, appears to be stuck." /><meta property="og:description" content="AWS Codepipeline cloudformation prepare stage not completing, appears to be stuck." /><link rel="canonical" href="https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/" /><meta property="og:url" content="https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/" /><meta property="og:site_name" content="Ivan Adam Vari" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-05T12:58:42+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS Codepipeline Stuck at Cloudformation Prepare Stage" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Iván Ádám Vári" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Iván Ádám Vári"},"dateModified":"2022-06-05T12:58:42+02:00","datePublished":"2022-06-05T12:58:42+02:00","description":"AWS Codepipeline cloudformation prepare stage not completing, appears to be stuck.","headline":"AWS Codepipeline Stuck at Cloudformation Prepare Stage","mainEntityOfPage":{"@type":"WebPage","@id":"https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/"},"url":"https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/"}</script><title>AWS Codepipeline Stuck at Cloudformation Prepare Stage | Ivan Adam Vari</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ivan Adam Vari"><meta name="application-name" content="Ivan Adam Vari"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-GST9H3668K"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GST9H3668K'); </script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ivan Adam Vari</a></div><div class="site-subtitle font-italic">A minimalist SysOps/DevOps Craftsman</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/variia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ivan.adam.vari','ivanvari.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/profile/view?id=ADEAAAZ6wwEBp7FjAqg_m7ZK8y148UI70Cyn9n8" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>AWS Codepipeline Stuck at Cloudformation Prepare Stage</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AWS Codepipeline Stuck at Cloudformation Prepare Stage</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/variia">Iván Ádám Vári</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1654426722" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-05 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="461 words"> <em>2 min</em> read</span></div></div></div><div class="post-content"><p>This issue puzzled me and even AWS support for weeks, although for the later it was mostly because of their availability not their skills:</p><blockquote class="prompt-info"><div><p>I pushed in an update for one of my pipeline managed stacks but the Cloudformation prepare stage was not completing. No errors, nothing but it was displaying “running” without doing anything really. The Cloudformation change-set was never created and after a day or two, it eventually timed out.</p></div></blockquote><p>As a standard course of action, I logged a support ticket, we went through the usual permission checks, our setup and so on but there was no clue so support escalated the ticket to backend engineering. After a couple of weeks of hassling our account manager and support, we got the information we needed and fixed it.</p><p>Partially, it was my fault but in the end I think AWS played a key role in this, hence we made a couple of requests to prevent this to happen in the future:</p><ul><li><p>Fix the service to include key backend information in CloudWatch</p><li><p>Update the documentation</p></ul><h2 id="background"><span class="mr-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We had our Elasticsearch service up for the Opensearch upgrade and it was managed with old, yaml style code and manual actions. As stated by the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticsearch-domain.html#aws-resource-elasticsearch-domain--remarks " target="_blank">documentation</a>, this change isn’t just clicking the <strong>upgrade</strong> button on console. There are specific steps to actually migrate the Cloudformation service objects into a new API compatible template and stack.</p><p>Since we built a new Codepipeline driven automated deployment framework for CDK generated Cloudformation templates, we thought how convenient it is, we can move the service to a new template/stack management platform too.</p><p>The migration is out of the scope of this article but basically, it included a step where the existing service object essentially needs to be imported into a new stack then updated and so on.</p><p>And this is where the process failed. It turns out, that Codepipeline does check the existing Cloudformation stack’s last status before proceeding:</p><blockquote class="prompt-warning"><div><p>“AWS workers are not able to update the stack because within this operation we treat the key/value pair for status_status=<code class="language-plaintext highlighter-rouge">IMPORT_COMPLETE</code> as a state which cannot be updated.”</p></div></blockquote><p>This is utterly wrong to me, it is needless to build such a logic into other services, they should just let Cloudformation to do its job and decide what is valid to update and what is not.</p><p>Updating a Cloudformation stack with <code class="language-plaintext highlighter-rouge">IMPORT_COMPLETE</code> last status is perfectly valid, but is is invalid for Codepipeline and to be frank, it is nonsense.</p><h2 id="solution"><span class="mr-2">Solution</span><a href="#solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote class="prompt-tip"><div><p>Update the stack manually (awscli, console, tool of your choice) with something, edit description, add a parameter, metadata or whatever you want, all we need is its status changed to <code class="language-plaintext highlighter-rouge">UPDATE_COMPLETE</code>.</p></div></blockquote><p>Once the stack is out of the <code class="language-plaintext highlighter-rouge">IMPORT_COMPLETE</code> state, Codepipeline will be be able to update the stack again.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aws/'>AWS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/cloud/" class="post-tag no-text-decoration" >cloud</a> <a href="/tags/codepipeline/" class="post-tag no-text-decoration" >codepipeline</a> <a href="/tags/cloudformation/" class="post-tag no-text-decoration" >cloudformation</a> <a href="/tags/cfn/" class="post-tag no-text-decoration" >cfn</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS Codepipeline Stuck at Cloudformation Prepare Stage - Ivan Adam Vari&amp;url=https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS Codepipeline Stuck at Cloudformation Prepare Stage - Ivan Adam Vari&amp;u=https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/&amp;text=AWS Codepipeline Stuck at Cloudformation Prepare Stage - Ivan Adam Vari" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cluster/">cluster</a> <a class="post-tag" href="/tags/couchbase/">couchbase</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/cfn/">cfn</a> <a class="post-tag" href="/tags/cloudformation/">cloudformation</a> <a class="post-tag" href="/tags/hardware/">hardware</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/aws-eks-stackset-cluster-access-recovery/"><div class="card-body"> <em class="timeago small" data-ts="1565958214" > 2019-08-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS EKS StackSet created cluster access recovery</h3><div class="text-muted small"><p> Kubernetes is contagious and nowadays hard to ignore. So we decided to look into EKS to see how it would work for our microservice suite. As of today, there are 2 ways of creating (official) an EKS...</p></div></div></a></div><div class="card"> <a href="/integrating-networks-vpn-amazon-vpc/"><div class="card-body"> <em class="timeago small" data-ts="1400451718" > 2014-05-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Integrating networks over VPN with Amazon VPC</h3><div class="text-muted small"><p> Amazon VPC has been out for some time offering full control of isolated local networking in the cloud. This means that you can have your own private subnet in the cloud, have control over what priv...</p></div></div></a></div><div class="card"> <a href="/aws-console-mfa-1password-otp-automation/"><div class="card-body"> <em class="timeago small" data-ts="1565817497" > 2019-08-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS MFA enabled console with automated one time password</h3><div class="text-muted small"><p> Moving to AWS is challenging and fun at the same time. Since our migration progresses well, we have enabled enforced MFA for IAM accounts, that have Administrator access. With 1Password OTP, it is...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/macOS-battery-health-and-optimised-charging/" class="btn btn-outline-primary" prompt="Older"><p>macOS Optimised Battery Charging</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://ivanvari.com/aws-codepipeline-stuck-at-cloudformation-prepare-stage/'; this.page.identifier = '/aws-codepipeline-stuck-at-cloudformation-prepare-stage/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://ivanvari-com.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/variia">Iván Ádám Vári</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cluster/">cluster</a> <a class="post-tag" href="/tags/couchbase/">couchbase</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/cfn/">cfn</a> <a class="post-tag" href="/tags/cloudformation/">cloudformation</a> <a class="post-tag" href="/tags/hardware/">hardware</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-84719456-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-84719456-1'); }); </script>
